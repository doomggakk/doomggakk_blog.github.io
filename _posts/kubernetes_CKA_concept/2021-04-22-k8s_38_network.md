---
layout: single
title: "[CKA Concept] 38. Network"
categories: [Kubernetes]
author_profile: true
excerpt: CKA 강의의 개념 중 Network에 대해 정리한다. 
toc: true
toc_sticky: true
---

## 네트워크
- A와 B라는 두대의 컴퓨터가 있을 때 A에서 B로 도달하는 방법
- 각각 스위치에 연결하고 스위치는 두시스템을 포함하는 네트워크를 만든다.
- 각 시스템을 스위치에 연결하기 위해서는 각 Host의 인터페이스가 필요하다.
- 호스트의 인터페이스는 호스트에따라 물리적이거나 가상일 수 있다. (ex: eth0)
- 호스트의 인터페이스를 확인하려면 ```ip link``` 명령어를 사용한다.
<br>

### 같은네트워크의 호스트에 IP주소 할당

- 네트워크를 192.168.1.0이라고 가정했을 때, 각 A와 B는 동일한 네트워크에 있으며 각각  192.168.1.10, 192.168.1.11로 IP주소를 할당한다. 할당은 다음명령어로 실행된다.

```
ip addr add 192.168.1.10/24 dev eth0 # A 호스트

ip addr add 192.168.1.11/24 dev eth0 # B 호스트
```

- 해당명령어를 실행하여 같은 네트워크로써의 IP주소를 할당한 뒤 A 호스트에서 ping을 날려 B호스트로부터 응답을 받을 수 있다.

```
ping 192.168.1.11
```

![](/assets/img/kubernetes/39_network_1.png)


<br>

### 다른 네트워크끼리의 통신은 어떻게 하는가?
-----------------------------------

#### 라우터
- 192.168.1.0의 네트워크에 속해있는 호스트에서 192.168.2.0 네트워크에 속해있는 호스트에 어떻게 통신할 수 있을까?
- 라우터를 사용하여 통신을 한다.
- 많은 네트워크 포트를 가진 또 다른 서버라고 생각할 수 있다.
- 두 네트워크를 연결해주는데 각 네트워크마다 IP가 할당 된다.
- 따라서 위에서 만들었던 두개의 네트워크는 각각 예를들어 192.168.1.1, 192.158.2.1의 IP가 할당될 수 있다.

#### 게이트웨이
- 두개의 네트워크를 라우터로 연결했는데 이제 중요한 것은 라우터가 네트워크의 어디에 위치하는지를 알아야한다.
- 이럴 때 사용하는 것이 게이트웨이이다.
- 네트워크를 방이라고 한다면, 게이트웨이는 외부의 세계를 다른 네트워크나 인터넷으로 연결하는 문이라고 할 수 있다.
- ```route``` 명령을 입력하면 Kernel IP routing table이 보인다.
- 이곳에 Destination과 게이트웨이를 지정하여야 다른 네트워크간의 연결이 이루어질 수 있다.
- 위에서 처럼 호스트 B(192.168.1.11)에서 호스트 C(192.168.2.10)로의 연결이 필요하다면 destination: 192.168.2.0(호스트 B의 네트워크 IP) GateWay : 192.168.1.1로 설정을 해주어야 한다.

```
ip route add <destination(network))>/24 via <gateway>

ip route add 192.168.2.0/24 via 192.168.1.1
```

- 반대의 연결도 필요하다면 반대로 또 등록을 해주어야한다.(C-> B)

```
ip route add 192.168.1.0/24 via 192.168.2.1
```

- 인터넷으로의 연결

```
ip route add 172.217.194.0/24 via 192.168.2.1
```

![](/assets/img/kubernetes/39_network_2.png)

<br>

#### Default 게이트웨이
- 한 네트워크에서 다른 네트워크로 연결이 되려할 때 결국 같은 라우터와 연결되는 GateWay는 똑같다.
- 따라서 일일이 IP를 지정해줄수도 있지만 해당네트워크에서 나가는 모든 연결을 다른 모든 IP와 연결될 수 있게 하는 방법이있다.
- Default 게이트웨이라고 하며 Destination을 default 혹은 0.0.0.0으로 지정해주면 된다.
- C호스트의 경우 같은 네트워크상에있는 다른 호스트로의 접근은 라우터 없이 가능하다 이러한 경우
Destination : 192.168.2.0(C 호스트의 네트워크 IP), Gateway: 0.0.0.0(사용하지 않음)
- 아래의 사진은 호스트 C의 route Table이며 인터넷으로 연결된 게이트웨이는 192.168.2.1이며 192.168.1.0으로 연결되는 게이트웨이는 192.168.2.2이다

![](/assets/img/kubernetes/39_network_3.png)

<br>

#### 라우터가 아닌 호스트를 통해 연결되는 경우

![](/assets/img/kubernetes/39_network_4.png)

- 위처럼 A호스트와 C호스트 사이에 두 호스트와 연결된 B호스트가 존재하는경우 A -> C로 연결을 어떻게 하는가?
- 우선 아무런 조치를 취하지 않는다면 A에서 C로의 연결은 되지 않는다.
- B호스트의 경우 A호스트와 연결된 인터페이스(eth0)에 할당된 IP(192.168.1.6)와 C호스트와 연결된 인터페이스(eth1)에 할당된 IP(192.168.2.5)가 따로 존재한다.
- A호스트에서 C호스트로의 연결을 가능하게 하려면 A의 Route table에 아래와 같이 추가하면된다.

```
# 호스트 A의 route table A->C
ip route add 192.168.2.0/24 via 192.168.1.6

# 호스트 C의 route table C->A
ip route add 192.168.1.0/24 via 192.168.2.6
```
- 게이트웨이를 호스트B와 연결된 IP로 입력하였다.
- 연결을 한 뒤 ping을 날려보면 연결되지않았다는 오류는 출력되지 않지만 응답이 돌아오지 않는다.
- 그 이유는 기본적으로 다른 인터페이스끼리는 패킷이 전달되지 않는다. eth0으로 수신한 패킷을 eth1을 통해 다른 곳으로 전달 되지 않는다는 것이다.
- 왜냐하면 예를들어 eth0을 개인네트워크와 연결하고 eth1을 공용네트워크와 연결하였을 때 개인네트워크(eth0)로 부터 받은 패킷이 공용네트워크(eth1)로 전달이 된다면 보안상으로 큰 문제가 발생할 수 있다.
- 패킷전달을 허용하려면 /proc/sys/net/ipv4/ip_forward 파일을 0에서 1로 바꿔주면 된다.
- 기본적으로 ip_forward를 바꿔주어도 재시작을 하게되면 그값이 유지되지않는다. 영구적으로 바꿔주려면 /etc/sysctl.conf파일에서 net.ipv4.ip_forward 값을 바꿔주어야 한다.

<br>

### Network관련 기본 명령어 정리

```
# 호스트의 인터페이스 나열
ip link

# 각 인터페이스에 할당된 IP주소 확인
ip addr

# 인터페이스에 IP주소 할당: 재시작하기전까지만 해당 기능이 유지된다.
# 영구적으로 적용하기 위해서는 /etc/network/interface 파일을 수정해야한다.
ip addr add 192.168.1.10/24 dev eth0

# 라우팅 테이블 조회
ip route

# 라우팅 테이블에 연결정보 추가
ip route add 192.168.1.0/24 via 192.168.2.1

# 다른 인터페이스로 패킷 전달 가능 여부 변경
cat /proc/sys/net/ipv4/ip_forward
1 # 전달 허용


```







<br>

------------------
**◎ 참고자료**
- Udemy - Certified Kubernetes Administrator (CKA) with Practice Tests
